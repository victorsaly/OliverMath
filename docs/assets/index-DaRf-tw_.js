const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/Assistant-B7gtyoq-.js","assets/ionic-core-CxxmTmYJ.js","assets/vue-vendor-D6lqZCUP.js","assets/speech-sdk-SapOic_u.js","assets/Assistant-D2kYHlrP.css"])))=>i.map(i=>d[i]);
import{l as I,n as r,d as X,q as c,t as v,v as a,x as U,y as m,z as g,A as Z,B as Y,C as J,D as h,E as C,F as ee}from"./vue-vendor-D6lqZCUP.js";import{I as te,a as se,b as ie,c as ne,d as oe,e as ae,f as re,g as ce,h as le,i as ue,j as he,k as de,l as pe,m as me,n as fe,o as ge,p as ve,q as ye,r as _e,s as Se,t as we,u as be,v as xe,w as Ee,_ as Ie,x as Ae}from"./ionic-core-CxxmTmYJ.js";import{r as Ce}from"./speech-sdk-SapOic_u.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const u of n.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&o(u)}).observe(document,{childList:!0,subtree:!0});function i(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function o(s){if(s.ep)return;s.ep=!0;const n=i(s);fetch(s.href,n)}})();const M=(e,t)=>{const i=e.__vccOpts||e;for(const[o,s]of t)i[o]=s;return i},ke=X({name:"App",components:{IonApp:se,IonRouterOutlet:te}});function Te(e,t,i,o,s,n){const u=c("ion-router-outlet"),d=c("ion-app");return v(),I(d,null,{default:r(()=>[a(u)]),_:1})}const Me=M(ke,[["render",Te]]),Re={name:"BotFace",props:{botState:{type:String,default:"neutral"},text:{type:String,default:""},isPlayMode:{type:Boolean,default:!0},audioLevel:{type:Number,default:0}},computed:{mouthClass(){return this.botState!=="speaking"||this.audioLevel===0?"":this.audioLevel>.7?"mouth-wide":this.audioLevel>.4?"mouth-medium":this.audioLevel>.15?"mouth-small":"mouth-closed"},mouthStyle(){if(this.botState!=="speaking")return{};const e=Math.min(this.audioLevel,1),t=4,o=t+e*(12-t),s=10,u=s+e*(25-s);return{width:`${u}%`,height:`${o}%`,left:`${50-u/2}%`,borderRadius:e>.3?"50%":"0.5em",transition:"all 0.05s ease-out"}}}},Le={class:"bubble speech"},Ne={id:"head"},Pe={id:"face"};function Oe(e,t,i,o,s,n){return v(),U("div",{id:"bot",class:J([i.botState,n.mouthClass])},[m("p",Le,g(i.text),1),m("div",Ne,[t[1]||(t[1]=m("div",{id:"left-ear"},[m("div",{id:"left-ear-inner"})],-1)),m("div",Pe,[t[0]||(t[0]=Z('<div id="eyebrows" data-v-5fca9a8a><div id="left-eyebrow" data-v-5fca9a8a></div><div id="right-eyebrow" data-v-5fca9a8a></div></div><div id="eyes" data-v-5fca9a8a><div id="left-eye" data-v-5fca9a8a><div id="left-pupil" data-v-5fca9a8a></div></div><div id="right-eye" data-v-5fca9a8a><div id="right-pupil" data-v-5fca9a8a></div></div></div><div id="cheeks" data-v-5fca9a8a><div id="left-cheek" data-v-5fca9a8a></div><div id="right-cheek" data-v-5fca9a8a></div></div>',3)),m("div",{id:"mouth",style:Y(n.mouthStyle)},null,4)]),t[2]||(t[2]=m("div",{id:"right-ear"},[m("div",{id:"right-ear-inner"})],-1))])],2)}const Be=M(Re,[["render",Oe],["__scopeId","data-v-5fca9a8a"]]);var k=Ce();const He="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' class='ionicon'><path d='M256 48C141.31 48 48 141.31 48 256s93.31 208 208 208 208-93.31 208-208S370.69 48 256 48m0 319.91a20 20 0 1 1 20-20 20 20 0 0 1-20 20m21.72-201.15-5.74 122a16 16 0 0 1-32 0l-5.74-121.94v-.05a21.74 21.74 0 1 1 43.44 0Z'/></svg>",Ue="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' class='ionicon'><path d='M416 80a48.05 48.05 0 0 0-48-48H144a48.05 48.05 0 0 0-48 48v352a48.05 48.05 0 0 0 48 48h224a48.05 48.05 0 0 0 48-48ZM168 432a24 24 0 1 1 24-24 24 24 0 0 1-24 24m0-80a24 24 0 1 1 24-24 24 24 0 0 1-24 24m0-80a24 24 0 1 1 24-24 24 24 0 0 1-24 24m88 160a24 24 0 1 1 24-24 24 24 0 0 1-24 24m0-80a24 24 0 1 1 24-24 24 24 0 0 1-24 24m0-80a24 24 0 1 1 24-24 24 24 0 0 1-24 24m112 136a24 24 0 0 1-48 0v-80a24 24 0 0 1 48 0Zm-24-136a24 24 0 1 1 24-24 24 24 0 0 1-24 24m19.31-100.69A16 16 0 0 1 352 176H160a16 16 0 0 1-16-16V96a16 16 0 0 1 16-16h192a16 16 0 0 1 16 16v64a16 16 0 0 1-4.69 11.31'/></svg>",De="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' class='ionicon'><path d='M192 448h128M384 208v32c0 70.4-57.6 128-128 128h0c-70.4 0-128-57.6-128-128v-32M256 368v80' stroke-linecap='round' stroke-linejoin='round' class='ionicon-fill-none ionicon-stroke-width'/><path d='M256 320a78.83 78.83 0 0 1-56.55-24.1A80.9 80.9 0 0 1 176 239V128a79.69 79.69 0 0 1 80-80c44.86 0 80 35.14 80 80v111c0 44.66-35.89 81-80 81'/></svg>",ze="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' class='ionicon'><path d='M133 440a35.37 35.37 0 0 1-17.5-4.67c-12-6.8-19.46-20-19.46-34.33V111c0-14.37 7.46-27.53 19.46-34.33a35.13 35.13 0 0 1 35.77.45l247.85 148.36a36 36 0 0 1 0 61l-247.89 148.4A35.5 35.5 0 0 1 133 440'/></svg>",Fe="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' class='ionicon'><path d='M425.7 118.25A240 240 0 0 0 76.32 447l.18.2c.33.35.64.71 1 1.05.74.84 1.58 1.79 2.57 2.78a41.17 41.17 0 0 0 60.36-.42 157.13 157.13 0 0 1 231.26 0 41.18 41.18 0 0 0 60.65.06l3.21-3.5.18-.2a239.93 239.93 0 0 0-10-328.76ZM240 128a16 16 0 0 1 32 0v32a16 16 0 0 1-32 0ZM128 304H96a16 16 0 0 1 0-32h32a16 16 0 0 1 0 32m48.8-95.2a16 16 0 0 1-22.62 0l-22.63-22.62a16 16 0 0 1 22.63-22.63l22.62 22.63a16 16 0 0 1 0 22.62m149.3 23.1-47.5 75.5a31 31 0 0 1-7 7 30.11 30.11 0 0 1-35-49l75.5-47.5a10.23 10.23 0 0 1 11.7 0 10.06 10.06 0 0 1 2.3 14m31.72-23.1a16 16 0 0 1-22.62-22.62l22.62-22.63a16 16 0 0 1 22.63 22.63ZM416 304h-32a16 16 0 0 1 0-32h32a16 16 0 0 1 0 32'/></svg>",$e="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' class='ionicon'><path d='M394 480a16 16 0 0 1-9.39-3L256 383.76 127.39 477a16 16 0 0 1-24.55-18.08L153 310.35 23 221.2a16 16 0 0 1 9-29.2h160.38l48.4-148.95a16 16 0 0 1 30.44 0l48.4 149H480a16 16 0 0 1 9.05 29.2L359 310.35l50.13 148.53A16 16 0 0 1 394 480'/></svg>",Ge="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' class='ionicon'><path d='M434.67 285.59v-29.8c0-98.73-80.24-178.79-179.2-178.79a179 179 0 0 0-140.14 67.36m-38.53 82v29.8C76.8 355 157 435 256 435a180.45 180.45 0 0 0 140-66.92' stroke-linecap='round' stroke-linejoin='round' class='ionicon-fill-none ionicon-stroke-width'/><path d='m32 256 44-44 46 44M480 256l-44 44-46-44' stroke-linecap='round' stroke-linejoin='round' class='ionicon-fill-none ionicon-stroke-width'/></svg>",qe="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' class='ionicon'><path d='M232 416a23.88 23.88 0 0 1-14.2-4.68 8 8 0 0 1-.66-.51L125.76 336H56a24 24 0 0 1-24-24V200a24 24 0 0 1 24-24h69.75l91.37-74.81a8 8 0 0 1 .66-.51A24 24 0 0 1 256 120v272a24 24 0 0 1-24 24M320 336a16 16 0 0 1-14.29-23.19c9.49-18.87 14.3-38 14.3-56.81 0-19.38-4.66-37.94-14.25-56.73a16 16 0 0 1 28.5-14.54C346.19 208.12 352 231.44 352 256c0 23.86-6 47.81-17.7 71.19A16 16 0 0 1 320 336'/><path d='M368 384a16 16 0 0 1-13.86-24C373.05 327.09 384 299.51 384 256c0-44.17-10.93-71.56-29.82-103.94a16 16 0 0 1 27.64-16.12C402.92 172.11 416 204.81 416 256c0 50.43-13.06 83.29-34.13 120a16 16 0 0 1-13.87 8'/><path d='M416 432a16 16 0 0 1-13.39-24.74C429.85 365.47 448 323.76 448 256c0-66.5-18.18-108.62-45.49-151.39a16 16 0 1 1 27-17.22C459.81 134.89 480 181.74 480 256c0 64.75-14.66 113.63-50.6 168.74A16 16 0 0 1 416 432'/></svg>",b={TIMES:"times",PLUS:"plus",MINUS:"minus",DIVIDE:"divide"},l={BEGINNER:"beginner",MEDIUM:"medium",EXPERT:"expert"},H={[b.TIMES]:{[l.BEGINNER]:{min1:1,max1:12,min2:1,max2:12},[l.MEDIUM]:{min1:3,max1:12,min2:3,max2:12},[l.EXPERT]:{min1:5,max1:20,min2:5,max2:20}},[b.PLUS]:{[l.BEGINNER]:{min1:1,max1:50,min2:1,max2:50},[l.MEDIUM]:{min1:1,max1:100,min2:1,max2:100},[l.EXPERT]:{min1:1,max1:1e3,min2:1,max2:1e3}},[b.MINUS]:{[l.BEGINNER]:{min1:10,max1:20,min2:1,max2:10},[l.MEDIUM]:{min1:20,max1:100,min2:1,max2:20},[l.EXPERT]:{min1:100,max1:500,min2:1,max2:100}},[b.DIVIDE]:{[l.BEGINNER]:{min1:1,max1:10,min2:1,max2:10},[l.MEDIUM]:{min1:2,max1:12,min2:2,max2:12},[l.EXPERT]:{min1:3,max1:15,min2:3,max2:15}}},y={ENCOURAGEMENT:["Well done!","Great work!","Good job!","Keep up the good work!","You've really got this!","Amazing!","Fantastic!","Superb!","Brilliant!","Excellent work!"],CORRECT:["That's correct","That's right","Exactly!","Flawless","Perfect","Spot on!","Nailed it!","You got it!"],INCORRECT:["Not quite","Maybe next time","I'm sure you can get the next one right","Incorrect","Close, but not quite","Almost there!","Give it another try!"],STREAK:["You're on fire!","Unstoppable!","What a streak!","Math genius!","Incredible run!"],HINTS:["Take your time!","Think step by step.","You can do this!"]},_={BASE_POINTS:1,STREAK_BONUS_THRESHOLD:3,STREAK_BONUS_MULTIPLIER:.5,MAX_STREAK_BONUS:3,LEVEL_MULTIPLIER:{[l.BEGINNER]:1,[l.MEDIUM]:1.5,[l.EXPERT]:2}};function T(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e}function S(e){return e[Math.floor(Math.random()*e.length)]}function We(e){return`${e} star${e===1?"":"s"}`}const Qe=1e4;function R(){return"https://olivermath-api.azurewebsites.net"}async function L(e,t={},i=Qe){const o=new AbortController,s=setTimeout(()=>o.abort(),i);try{return await fetch(e,{...t,signal:o.signal})}finally{clearTimeout(s)}}async function Ve(){const e=await L(`${R()}/api/speechToken`);if(!e.ok)throw new Error(`Speech token request failed: ${e.status}`);return e.json()}async function je(e,t="en-GB-RyanNeural",i="default"){if(!e||e.trim().length===0)throw new Error("Text is required for speech synthesis");const o=e.slice(0,500),s=await L(`${R()}/api/speak`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:o,voice:t,style:i})});if(!s.ok){const n=await s.json().catch(()=>({}));throw new Error(n.error||`TTS request failed: ${s.status}`)}return s.json()}async function Ke(e,t,i){if(!e)return{correct:!1,understood:!1,interpretedNumber:null,confidence:"low"};const o=await L(`${R()}/api/validateAnswer`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({spokenText:e,expectedAnswer:t,question:i})});if(!o.ok){console.warn("validateAnswer API failed, falling back to simple extraction");const s=String(e).match(/\d+/),n=s?parseInt(s[0],10):null;return{correct:n===t,understood:n!==null,interpretedNumber:n,confidence:"low"}}return o.json()}const w=new Map,Xe=20;async function Ze(e){const t=e.toLowerCase().trim();if(w.has(t)){const s=w.get(t);return s.currentTime=0,s}const i=await je(e),o=new Audio(`data:audio/mpeg;base64,${i.audio}`);if(w.size>=Xe){const s=w.keys().next().value;w.delete(s)}return w.set(t,o),o}const Ye={name:"Math",components:{BotFace:Be,IonHeader:we,IonToolbar:Se,IonTitle:_e,IonContent:ye,IonPage:ve,IonChip:ge,IonLabel:fe,IonIcon:me,IonItem:pe,IonSelect:de,IonSelectOption:he,IonButton:ue,IonFooter:le,IonCard:ce,IonCardContent:re,IonGrid:ae,IonRow:oe,IonCol:ne,IonSpinner:ie},setup(){return{star:$e,playIcon:ze,speedometerIcon:Fe,calculatorIcon:Ue,micIcon:De,volumeIcon:qe,syncIcon:Ge,alertIcon:He}},data(){return{typeText:[],isLoading:!0,isOnBoundary:!1,isTalking:!1,isListening:!1,isComputing:!1,isLaughing:!1,isError:!1,isQuery:!1,isPlayMode:!0,isResolved:!1,isHappy:!1,isSad:!1,isExcited:!1,isProud:!1,isSurprised:!1,isConfused:!1,text:"",selectedLevel:l.MEDIUM,selectedOperator:b.TIMES,speech_phrases:"Click play, listen the question and respond back by talking your answer.",number1:2,number2:3,stars:0,highScore:0,bestStreak:0,previousPosition:-1,consecutiveCorrect:0,totalQuestionsAnswered:0,synth:window.speechSynthesis,greetingSpeech:new window.SpeechSynthesisUtterance,audioConfig:null,speechConfig:null,speechRecognizer:null,speechRecording:null,token:null,speechRegion:null,audioPlayer:null,audioContext:null,audioAnalyser:null,audioSource:null,audioLevel:0,animationFrameId:null,isMicrophoneEnabled:!1,publicPath:"/OliverMath/",timeout:null,expressionTimeout:null}},computed:{botState(){return this.isError?"broken":this.isLaughing?"laughing":this.isHappy?"happy":this.isSad?"sad":this.isExcited?"excited":this.isProud?"proud":this.isSurprised?"surprised":this.isConfused?"confused":this.isTalking?"speaking":this.isListening?"listening":this.isComputing?"computing":"thinking"},expectedResultAsNumber(){return this.selectedOperator=="plus"?this.number1+this.number2:this.selectedOperator=="minus"?this.number1-this.number2:this.selectedOperator=="divide"?this.number1/this.number2:this.number1*this.number2},statusColor(){switch(this.botState){case"speaking":return"primary";case"listening":return"success";case"computing":return"warning";case"broken":return"danger";case"laughing":return"tertiary";case"happy":return"success";case"sad":return"primary";case"excited":return"secondary";case"proud":return"warning";case"surprised":return"tertiary";case"confused":return"medium";default:return"medium"}},statusText(){switch(this.botState){case"speaking":return"Speaking...";case"listening":return"Listening...";case"computing":return"Processing...";case"broken":return"Error";case"laughing":return"Haha!";case"happy":return"Correct! ðŸŽ‰";case"sad":return"Try again...";case"excited":return"Amazing!";case"proud":return"Great streak!";case"surprised":return"Wow!";case"confused":return"Hmm...";default:return"Ready"}},statusIcon(){switch(this.botState){case"speaking":return this.volumeIcon;case"listening":return this.micIcon;case"computing":return this.syncIcon;case"broken":return this.alertIcon;case"happy":return this.starIcon;case"sad":return this.alertIcon;case"excited":return this.starIcon;case"proud":return this.starIcon;case"surprised":return this.starIcon;case"confused":return this.syncIcon;default:return this.syncIcon}}},methods:{showExpression(e,t=2e3){switch(this.isHappy=!1,this.isSad=!1,this.isExcited=!1,this.isProud=!1,this.isSurprised=!1,this.isConfused=!1,e){case"happy":this.isHappy=!0;break;case"sad":this.isSad=!0;break;case"excited":this.isExcited=!0;break;case"proud":this.isProud=!0;break;case"surprised":this.isSurprised=!0;break;case"confused":this.isConfused=!0;break}this.expressionTimeout&&clearTimeout(this.expressionTimeout),this.expressionTimeout=setTimeout(()=>{this.isHappy=!1,this.isSad=!1,this.isExcited=!1,this.isProud=!1,this.isSurprised=!1,this.isConfused=!1},t)},initAudioAnalysis(){this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.audioAnalyser=this.audioContext.createAnalyser(),this.audioAnalyser.fftSize=256,this.audioAnalyser.smoothingTimeConstant=.3)},startAudioAnalysis(e){if(this.initAudioAnalysis(),this.audioSource)try{this.audioSource.disconnect()}catch{}try{this.audioSource=this.audioContext.createMediaElementSource(e),this.audioSource.connect(this.audioAnalyser),this.audioAnalyser.connect(this.audioContext.destination)}catch(t){console.warn("Audio source already connected:",t.message)}this.audioContext.state==="suspended"&&this.audioContext.resume(),this.analyzeAudio()},analyzeAudio(){if(!this.isTalking||!this.audioAnalyser){this.audioLevel=0;return}(!this._audioDataArray||this._audioDataArray.length!==this.audioAnalyser.frequencyBinCount)&&(this._audioDataArray=new Uint8Array(this.audioAnalyser.frequencyBinCount),this._voiceStart=Math.floor(80/(this.audioContext.sampleRate/this.audioAnalyser.fftSize)),this._voiceEnd=Math.floor(3e3/(this.audioContext.sampleRate/this.audioAnalyser.fftSize))),this.audioAnalyser.getByteFrequencyData(this._audioDataArray);let e=0;const t=Math.min(this._voiceEnd,this._audioDataArray.length);for(let s=this._voiceStart;s<t;s++)e+=this._audioDataArray[s];const i=t-this._voiceStart,o=i>0?e/i:0;this.audioLevel=Math.min(1,o/128*1.5),this.animationFrameId=requestAnimationFrame(()=>this.analyzeAudio())},stopAudioAnalysis(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.audioLevel=0,this._audioDataArray=null,this._voiceStart=null,this._voiceEnd=null},changeStatus(e){if(this.timeout&&e=="laughing"){var t=new Audio(window.location.origin+this.$route.path+this.publicPath+"assets/sound/laugh.wav");t.play(),this.isLaughing=!0}clearTimeout(this.timeout),this.timeout=setTimeout(()=>{this.isLaughing=!1},1500)},keyDownHandler(e){let t=e.key*1;!isNaN(parseFloat(t))&&isFinite(t)&&(this.typeText.push(t),this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(async()=>{if(this.typeText.length>0){var i=this.typeText.join("");this.showToast("Your typed response: "+i,"secondary");const o=parseInt(i,10);!isNaN(o)&&o===this.expectedResultAsNumber&&(this.isResolved=!0,await this.validateSpeechRecording(i,!0)),this.typeText=[]}},400))},async showToast(e,t){return(await be.create({message:e,duration:5e3,color:t,translucent:!1,cssClass:"toast-custom-position",animated:!1})).present()},async enableMicrophone(){var e=this;this.isMicrophoneEnabled||(e.speech_phrases="enabling microphone..",e.isMicrophoneEnabled=!0,await navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(function(t){e.audioConfig=k.AudioConfig.fromMicrophoneInput(t.id),e.speech_phrases="microphone enabled"}).catch(function(){e.speech_phrases="microphone disabled",e.isError=!0,e.showToast("Microphone disabled","danger"),e.isMicrophoneEnabled=!1}))},async askQuestion(){this.audioConfig=k.AudioConfig.fromDefaultMicrophoneInput(),this.isResolved=!1;var e=this;this.isComputing=!0,this.showExpression("surprised",800),await this.enableMicrophone().then(function(){var t;if(e.isMicrophoneEnabled){e.isComputing=!1,e.isQuery=!0,e.isPlayMode=!1,e.speech_phrases="";const i=((t=H[e.selectedOperator])==null?void 0:t[e.selectedLevel])||H[b.TIMES][l.BEGINNER];if(e.selectedOperator==="divide"){const s=T(i.min2,i.max2),n=T(i.min1,i.max1);e.number1=s*n,e.number2=s}else e.number1=T(i.min1,i.max1),e.number2=T(i.min2,i.max2);const o=e.selectedOperator==="divide"?"divided by":e.selectedOperator;e.text=`What's ${e.number1} ${o} ${e.number2}?`,e.speak()}else e.speech_phrases="microphone not available",e.isError=!0,e.showToast("Microphone not available","danger")}).catch(function(t){console.error("Failed to ask question:",t),e.isError=!0,e.text="Something went wrong. Please try again.",e.showToast(e.text,"danger")})},async speak(){if(!(this.audioPlayer&&!this.audioPlayer.paused)){this.speech_phrases=this.text,this.isTalking=!0,this.isOnBoundary=!0;try{const e=await Ze(this.text);this.audioPlayer=e,e.crossOrigin="anonymous",e.onplay=()=>{this.startAudioAnalysis(e)},e.onended=()=>{this.isTalking=!1,this.stopAudioAnalysis(),this.isQuery&&(this.isQuery=!1,this.listen())},e.onerror=()=>{this.isTalking=!1,this.stopAudioAnalysis(),this.speakWithBrowser()},await e.play()}catch(e){console.error("Azure TTS error:",e),this.isTalking=!1,this.stopAudioAnalysis(),this.speakWithBrowser()}}},speakWithBrowser(){this.synth.speaking||(this.greetingSpeech.text=this.text,this.synth.speak(this.greetingSpeech))},listen(){this.showToast("Listening...","warning"),this.isComputing=!0,this.isListening=!1;var e=k.SpeechConfig.fromAuthorizationToken(this.token,this.speechRegion);e.speechRecognitionLanguage="en-GB",this.speechConfig=e,this.speechRecording=new k.SpeechRecognizer(this.speechConfig,this.audioConfig),this.listenForSpeechRecordingEvents()},listenForSpeechRecordingEvents(){const e=this;this.speechRecording.speechStartDetected=function(){console.log("speechStartDetected"),e.showToast("I'm Listening","success"),e.isListening=!0,e.isComputing=!1},this.speechRecording.recognizing=function(t,i){window.console.log("recognizing ",i.result.text),e.validateSpeechRecording(i.result.text,!1)},this.speechRecording.recognizeOnceAsync(function(t){e.validateSpeechRecording(t.text,!0),e.isListening=!1,e.isComputing=!1,e.speechRecording.close(),e.speechRecording=null},function(t){console.log("err recognizeOnceAsync",t),e.showToast("Unable to connect to the server.","danger"),e.isListening=!1,e.isComputing=!1,e.isQuery=!1,e.isError=!0,e.text="Unable to recognized the voice. Internal error",e.showToast(e.text),e.speechRecording.close(),e.speechRecording=null})},listenForSpeechEvents(){this.greetingSpeech.onstart=()=>{this.isTalking=!0,this.isOnBoundary=!1,this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(()=>{this.isOnBoundary||(this.speech_phrases=this.text,this.isOnBoundary=!0)},600)},this.greetingSpeech.onend=()=>{this.isTalking=!1,this.isQuery&&(this.isQuery=!1,this.listen())},this.greetingSpeech.onboundary=e=>{if(this.isOnBoundary=!0,e.name=="word"){var t=this.getWordAt(this.text,e.charIndex).toLowerCase();t=="times"&&(t="x"),t=="plus"&&(t="+"),t=="minus"&&(t="-"),this.speech_phrases+=t+" "}}},calculatePoints(){const e=_.LEVEL_MULTIPLIER[this.selectedLevel]||1;let t=1;if(this.consecutiveCorrect>=_.STREAK_BONUS_THRESHOLD){const i=this.consecutiveCorrect-_.STREAK_BONUS_THRESHOLD+1;t=Math.min(1+i*_.STREAK_BONUS_MULTIPLIER,_.MAX_STREAK_BONUS)}return Math.round(_.BASE_POINTS*e*t)},triggerHaptic(e="light"){if("vibrate"in navigator){const t={light:[10],medium:[20],heavy:[50],success:[10,50,10],error:[50,30,50]};navigator.vibrate(t[e]||t.light)}},async validateWordWithLLM(e){if(!(!e||this.isResolved))try{const t=await Ke(e,this.expectedResultAsNumber,this.text);return t.correct&&(this.isResolved=!0),t.understood&&t.interpretedNumber!==null&&console.log(`LLM interpreted "${e}" as ${t.interpretedNumber} (confidence: ${t.confidence})`),t}catch(t){console.error("LLM validation failed:",t);const i=String(e).match(/\d+/),o=i?parseInt(i[0],10):null;return o!==null&&o===this.expectedResultAsNumber&&(this.isResolved=!0),{correct:this.isResolved,understood:o!==null}}},async validateSpeechRecording(e,t){const i=e===void 0||e==="",o=i?"(silent)":String(e);let s=null;if(i)t&&this.showExpression("confused",2e3);else if(this.showToast(`I heard: "${o}"`,"secondary"),this.isComputing=!0,s=await this.validateWordWithLLM(e),this.isComputing=!1,s!=null&&s.understood&&s.interpretedNumber!==null){const n=s.interpretedNumber;this.showToast(`Interpreted as: ${n}`,s.correct?"success":"warning")}if(t&&this.totalQuestionsAnswered++,this.isResolved){this.consecutiveCorrect++;const n=this.calculatePoints();this.stars+=n,this.consecutiveCorrect>this.bestStreak&&(this.bestStreak=this.consecutiveCorrect,localStorage.bestStreak=this.bestStreak),this.stars>this.highScore&&(this.highScore=this.stars,localStorage.highScore=this.highScore),localStorage.stars=this.stars,localStorage.totalQuestions=this.totalQuestionsAnswered,this.triggerHaptic(this.consecutiveCorrect>=5?"success":"light");const u=S(y.CORRECT);let d="";if(this.consecutiveCorrect>=5){const p=S(y.STREAK);d=`${u}! ${p} ${this.consecutiveCorrect} in a row! +${n} stars!`,this.showExpression("excited",3e3)}else if(this.consecutiveCorrect>=3){const p=S(y.ENCOURAGEMENT);d=`${u}! ${p} Streak of ${this.consecutiveCorrect}! +${n} stars!`,this.showExpression("proud",2500)}else{const p=S(y.ENCOURAGEMENT);d=`${u}, ${p} You earned ${We(this.stars)}.`,this.showExpression("happy",2e3)}this.text=d}else if(t){this.consecutiveCorrect=0,this.triggerHaptic("error");const n=S(y.INCORRECT),u=S(y.HINTS);this.text=`${n}, the correct answer is ${this.expectedResultAsNumber}. ${u}`,i||this.showExpression("sad",2e3)}t&&(this.speak(),this.isPlayMode=!0)},getWordAt(e,t){if(e=String(e),t=Number(t)>>>0,this.previousPosition===t)return this.isTalking=!1,"";this.previousPosition=t;const i=e.slice(0,t+1).search(/\S+$/),o=e.slice(t).search(/\s/);return o<0?(this.isQuery||(this.isPlayMode=!0),this.isTalking=!1,e.slice(i)):e.slice(i,o+t)}},async mounted(){try{await navigator.mediaDevices.getUserMedia({audio:!0}),this.isMicrophoneEnabled=!0}catch{console.warn("Microphone not available")}this.listenForSpeechEvents();const e=localStorage.getItem("stars");e&&(this.stars=parseInt(e,10)||0);const t=localStorage.getItem("highScore");t&&(this.highScore=parseInt(t,10)||0);const i=localStorage.getItem("bestStreak");i&&(this.bestStreak=parseInt(i,10)||0);const o=localStorage.getItem("totalQuestions");o&&(this.totalQuestionsAnswered=parseInt(o,10)||0);try{const{token:s,region:n}=await Ve();this.token=s,this.speechRegion=n}catch(s){console.error("Failed to get speech token:",s),this.isError=!0,this.speech_phrases="Server is unavailable. Please refresh the page.",this.showToast(this.speech_phrases,"danger")}},created(){window.addEventListener("keydown",this.keyDownHandler)},unmounted(){window.removeEventListener("keydown",this.keyDownHandler),this.audioPlayer&&(this.audioPlayer.pause(),this.audioPlayer=null),this.stopAudioAnalysis(),this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.timeout&&clearTimeout(this.timeout),this.expressionTimeout&&clearTimeout(this.expressionTimeout)}},Je={class:"bot-container"},et={key:0,class:"status-indicator"};function tt(e,t,i,o,s,n){const u=c("ion-title"),d=c("ion-icon"),p=c("ion-label"),x=c("ion-chip"),N=c("ion-toolbar"),z=c("ion-header"),f=c("ion-select-option"),P=c("ion-select"),O=c("ion-item"),E=c("ion-col"),B=c("ion-row"),F=c("ion-grid"),$=c("ion-card-content"),G=c("ion-card"),q=c("BotFace"),W=c("ion-content"),Q=c("ion-spinner"),V=c("ion-button"),j=c("ion-footer"),K=c("ion-page");return v(),I(K,null,{default:r(()=>[a(z,null,{default:r(()=>[a(N,{color:"primary"},{default:r(()=>[a(u,null,{default:r(()=>[...t[3]||(t[3]=[h("Math Game",-1)])]),_:1}),a(x,{slot:"end",color:"warning","aria-label":"Stars earned"},{default:r(()=>[a(d,{icon:o.star,"aria-hidden":"true"},null,8,["icon"]),a(p,null,{default:r(()=>[h(g(s.stars),1)]),_:1})]),_:1})]),_:1})]),_:1}),a(W,{fullscreen:!0,class:"ion-padding",role:"main"},{default:r(()=>[a(G,{class:"settings-card"},{default:r(()=>[a($,null,{default:r(()=>[a(F,null,{default:r(()=>[a(B,{class:"ion-align-items-center"},{default:r(()=>[a(E,{size:"6"},{default:r(()=>[a(O,{lines:"none",class:"setting-item"},{default:r(()=>[a(d,{icon:o.speedometerIcon,slot:"start",color:"primary"},null,8,["icon"]),a(P,{interface:"popover",value:s.selectedLevel,onIonChange:t[0]||(t[0]=A=>s.selectedLevel=A.target.value),label:"Level","label-placement":"stacked"},{default:r(()=>[a(f,{value:"beginner"},{default:r(()=>[...t[4]||(t[4]=[h("Beginner",-1)])]),_:1}),a(f,{value:"medium"},{default:r(()=>[...t[5]||(t[5]=[h("Medium",-1)])]),_:1}),a(f,{value:"expert"},{default:r(()=>[...t[6]||(t[6]=[h("Expert",-1)])]),_:1})]),_:1},8,["value"])]),_:1})]),_:1}),a(E,{size:"6"},{default:r(()=>[a(O,{lines:"none",class:"setting-item"},{default:r(()=>[a(d,{icon:o.calculatorIcon,slot:"start",color:"secondary"},null,8,["icon"]),a(P,{interface:"popover",value:s.selectedOperator,onIonChange:t[1]||(t[1]=A=>s.selectedOperator=A.target.value),label:"Operator","label-placement":"stacked"},{default:r(()=>[a(f,{value:"times"},{default:r(()=>[...t[7]||(t[7]=[h("Ã— Multiply",-1)])]),_:1}),a(f,{value:"plus"},{default:r(()=>[...t[8]||(t[8]=[h("+ Addition",-1)])]),_:1}),a(f,{value:"minus"},{default:r(()=>[...t[9]||(t[9]=[h("âˆ’ Subtract",-1)])]),_:1}),a(f,{value:"divide"},{default:r(()=>[...t[10]||(t[10]=[h("Ã· Division",-1)])]),_:1})]),_:1},8,["value"])]),_:1})]),_:1})]),_:1}),a(B,{class:"stats-row ion-align-items-center ion-justify-content-center"},{default:r(()=>[a(E,{size:"auto"},{default:r(()=>[a(x,{color:"tertiary",outline:"",class:"stat-chip"},{default:r(()=>[a(p,null,{default:r(()=>[h("ðŸ† Best: "+g(s.highScore),1)]),_:1})]),_:1})]),_:1}),a(E,{size:"auto"},{default:r(()=>[a(x,{color:"secondary",outline:"",class:"stat-chip"},{default:r(()=>[a(p,null,{default:r(()=>[h("ðŸ”¥ Streak: "+g(s.consecutiveCorrect),1)]),_:1})]),_:1})]),_:1}),a(E,{size:"auto"},{default:r(()=>[a(x,{color:"success",outline:"",class:"stat-chip"},{default:r(()=>[a(p,null,{default:r(()=>[h("â­ Best: "+g(s.bestStreak),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),m("div",Je,[a(q,{botState:n.botState,isPlayMode:s.isPlayMode,text:s.speech_phrases,audioLevel:s.audioLevel,onAsk_question:n.askQuestion,onClick:t[2]||(t[2]=A=>n.changeStatus("laughing")),"aria-live":"polite"},null,8,["botState","isPlayMode","text","audioLevel","onAsk_question"])]),n.botState!=="thinking"?(v(),U("div",et,[a(x,{color:n.statusColor,outline:""},{default:r(()=>[a(d,{icon:n.statusIcon,"aria-hidden":"true"},null,8,["icon"]),a(p,null,{default:r(()=>[h(g(n.statusText),1)]),_:1})]),_:1},8,["color"])])):C("",!0)]),_:1}),a(j,{class:"ion-no-border"},{default:r(()=>[a(N,null,{default:r(()=>[s.isPlayMode&&n.botState!=="broken"?(v(),I(V,{key:0,expand:"block",size:"large",onClick:n.askQuestion,disabled:s.isComputing,class:"play-button","aria-label":"Start a new math question"},{default:r(()=>[s.isComputing?C("",!0):(v(),I(d,{key:0,icon:o.playIcon,slot:"start"},null,8,["icon"])),s.isComputing?(v(),I(Q,{key:1,name:"crescent"})):C("",!0),h(" "+g(s.isComputing?"Thinking...":"Play Math!"),1)]),_:1},8,["onClick","disabled"])):C("",!0)]),_:1})]),_:1})]),_:1})}const st=M(Ye,[["render",tt],["__scopeId","data-v-0ba69422"]]),it=()=>Ie(()=>import("./Assistant-B7gtyoq-.js"),__vite__mapDeps([0,1,2,3,4])),nt=[{path:"/",name:"Home",component:st},{path:"/assistant",name:"Assistant",component:it}],D=xe({history:Ee("/OliverMath/"),routes:nt}),ot=ee(Me).use(Ae).use(D);D.isReady().then(()=>{ot.mount("#app")});export{M as _};
